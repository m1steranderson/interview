##
# NATS + Microservice (workers deploy via GitHub Actions)
#
# Usage:
#   cd deploy
#   cp .env.example .env   # fill in CF credentials
#   docker compose up --build
#
# Test:
#   nats pub tasks.created '{"id":"test-001","title":"Buy milk"}'
#   nats pub tasks.updated '{"id":"test-001","status":"in_progress"}'
#   nats pub tasks.deleted '{"id":"test-001"}'
#   curl https://task-manager-web.<account_id>.workers.dev/api/tasks
##

services:
  nats:
    image: nats:2-alpine
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--http_port", "8222"]
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 3s
      timeout: 3s
      retries: 5

  microservice:
    build:
      context: .
      dockerfile: packages/microservice/Dockerfile
    depends_on:
      nats:
        condition: service_healthy
    environment:
      NATS_URL: nats://nats:4222
      CF_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}
      CF_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
      CF_NAMESPACE_ID: ${CF_NAMESPACE_ID}
      KV_SECRET: ${KV_SECRET}
      WEB_APP_URL: ${WEB_APP_URL}
      KV_SERVICE_URL: ${KV_SERVICE_URL}
    restart: unless-stopped
